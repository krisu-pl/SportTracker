"use strict";$(document).ready(function(){function t(t){var e=JSON.parse(sessionStorage.getItem(a));e||(e={}),e[t]=!0,sessionStorage.setItem(a,JSON.stringify(e))}function e(t){var e=JSON.parse(sessionStorage.getItem(a));e&&e[t]&&delete e[t],sessionStorage.setItem(a,JSON.stringify(e))}var a=$("#event-id").data("event-id"),i=$("#event_start_date").text();$("#event_start_date").text(moment(i).format("Do MMMM YYYY, HH:mm:ss"));var n={},o=L.map("map"),r=new L.tileLayer("https://api.mapbox.com/styles/v1/krisu/ciqpgxyy0003wcankixy95bud/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoia3Jpc3UiLCJhIjoiY2lxcGd5enllMDA2MGh5bWFrYnA0Z2hwMiJ9.4j9N70VORhhTh1eUOSjL3A",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://mapbox.com">Mapbox</a>',maxZoom:18}).addTo(o),d=L.control.elevation({theme:"steelblue-theme",width:600,height:100,margins:{top:0,right:0,bottom:0,left:0}});d.addTo(o);var s="trasa.gpx",l=new L.GPX(s,{async:!0,marker_options:{startIconUrl:"../images/pin-icon-start.png",endIconUrl:"../images/pin-icon-end.png",shadowUrl:"../images/pin-shadow.png"}});l.on("loaded",function(t){o.fitBounds(t.target.getBounds())}),l.on("addline",function(t){d.addData(t.line)}),l.addTo(o),o.addLayer(r);var p=$("#event-data-table"),c=p.DataTable({dom:'<<"general-table-top"lf><t><"general-table-bottom"ip>>'}),h=$("#following-data-table"),m=io();m.on("connect",function(){m.emit("follow-event",a)}),m.on("refresh",function(t){var e=$("#event-data-table").find("td[data-checkpoint-id='"+t.checkpoint_id+"'][data-participant-id='"+t.participant_id+"']").eq(0),a=$("#following-data-table").find("td[data-checkpoint-id='"+t.checkpoint_id+"'][data-participant-id='"+t.participant_id+"']").eq(0);if(e.length>0){var i=c.cell(e);i.data(t.time),e.addClass("updated"),i.draw(),setTimeout(function(){e.removeClass("updated")},3e3)}a.length>0&&(a.text(t.time),a.addClass("updated"),setTimeout(function(){a.removeClass("updated")},3e3))}),m.on("location-update",function(t){var e=n[t.participant_event_id];e&&(e.getLatLng().equals(L.latLng(0,0))&&e.addTo(o),e.setLatLng(L.latLng(t.lat,t.lng)))}),p.on("click","span.follow",function(){var e=$(this).parents("tr").data("participant-event-id");$(this).hide(),$(this).siblings(".unfollow").show(),m.emit("follow-participant",e);var a=$(this).parent().siblings(".participant_name").text();n[e]=L.marker([0,0]).bindLabel(""+a,{noHide:!0,direction:"auto"});var i=$(this).parents("tr").clone(),o=i.children("td");o.splice(1,3),o.splice(o.length-1,1),h.children("tbody").append('<tr data-participant-event-id="'+e+'">'),h.children("tbody").children("tr:last").append(o),t(e)}).on("click","span.unfollow",function(){var t=$(this).parents("tr").data("participant-event-id");$(this).hide(),$(this).siblings(".follow").show(),m.emit("unfollow-participant",t),delete n[t],h.find('tr[data-participant-event-id="'+t+'"]').remove(),e(t)}),function(){var t=JSON.parse(sessionStorage.getItem(a));for(var e in t)p.find('tr[data-participant-event-id="'+e+'"]').find("span.follow").trigger("click")}(),function(){var t=1e3,e=60*t,a=60*e,i=$("#event-time").data("startdate"),n=new Date(i),o=function(){var i=new Date,o=i-n,r="",d=void 0,s=void 0,l=void 0;o<0?(r="-",d=Math.ceil(o/a)*-1,s=Math.ceil(o%a/e)*-1,l=Math.ceil(o%e/t)*-1):(d=Math.floor(o/a),s=Math.floor(o%a/e),l=Math.floor(o%e/t)),$("#event-time").html(r+f(d)+":"+f(s)+":"+f(l))};setInterval(o,1e3)}();var f=function(t){return("0"+t).slice(-2)}});